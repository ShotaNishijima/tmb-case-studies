---
title: "Survival"
author: "Hans Skaug, Jens Wahl, Olav Breivik"
date: "6 juni 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(TMB)
```

## **Survival**

In the first example we looked at the recruitment process, where we estimated how many fish we expect to be born in a given year. The next step is to look at the survivial function for all age groups. This will be denoted $N_{a,y}$, where $a$ is the age of the fish and $y$ is the year. For example, $N_{1, 8}$ is the number of fish of age 1 in year 8 (i.e $R_8$). The number of fish next year equals the number of fish this year minus those who have died and added those who have been born. This can be expressed mathematically as:

\begin{align}
\log N_{a,y} = \log N_{a-1,y-1} - F_{a-1,y-1} - M_{a-1, y-1} + \xi_{ay}, \quad \text{where } \xi_{ay} \sim  N(0, \sigma_S^2)
\end{align}

where $F$ is the fishing mortality and $M$ is the natural mortality. If our model contains a maximum age group $A$, then the survival for age $A$ is given by: 

\[
  \log N_{a,y} = \log N_{A-1,y-1} - F_{A-1,y-1} - M_{A-1, y-1} - \log N_{A,y-1} - F_{A,y-1} - M_{A, y-1},
\]
where the contribution is the survival form last year in the age group below, but also from the same age group from last year, since this is the maximum age. 

*** 

### Survival as state space model 

As we did with the recruitment process, we will modell the recruitment as a state space model in the following way: 

\[
  \log N_{ay}^{(\text{obs})} = \log N_{a,y} + \epsilon_{ay}, \quad \text{where } \epsilon_{ay} \sim N(0, \sigma^2).
\]


***

### Full code for example 

<details> 
  <summary> R code </summary> 
```{r, echo = TRUE, warning=F}
load("Nobs.RData")
matplot(log(Nobs$Nobs), main="logN")

compile("survival.cpp")
dyn.load(dynlib("survival"))

# Prepare for TMB
param <- list(logN = matrix(0 ,nrow = nrow(Nobs$Nobs), ncol = ncol(Nobs$Nobs)),
              log_sigma_Nobs = 0, 
              log_sigma_logN = 0,
              log_sigma_logR = 0)

data <- list(Nobs = Nobs$Nobs,
             F = Nobs$F,
             M = Nobs$M)

obj <- MakeADFun(data, param, random = "logN", DLL = "survival")
opt <- nlminb(obj$par, obj$fn, obj$gr, control = list(trace = 0))

rep <- sdreport(obj)

logN_rep <- summary(rep, "random")

# Add lines for estimated survival for all age groups
matplot(as.list(rep ,"Est")$logN, type="l", add=TRUE)

```
  
</details> 

<details> 
  <summary> C++ code </summary> 
```c++
#include <TMB.hpp>

template<class Type> 
Type objective_function<Type>::operator()(){
  
  DATA_MATRIX(Nobs); 
  DATA_MATRIX(M); 
  DATA_MATRIX(F); 
  
  PARAMETER_MATRIX(logN); // Survival matrix for all age groups and years 
  PARAMETER(log_sigma_Nobs); // standard deviation for observations 
  PARAMETER(log_sigma_logN); // standard devitation for state equation
  PARAMETER(log_sigma_logR); // stadard deviation for recruitment 
  
  // Transform parameters
  Type sigma_Nobs = exp(log_sigma_Nobs); 
  Type sigma_logN = exp(log_sigma_logN); 
  Type sigma_logR = exp(log_sigma_logR);
  
  // Report to R
  ADREPORT(sigma_logN);
  ADREPORT(sigma_Nobs);
  ADREPORT(sigma_logR);
  

  
  Type nll = 0; 
  int n_year = Nobs.rows();
  int n_age = Nobs.cols(); 
  
  // Recruitment for age zero
  for(int y = 1; y < n_year; y++){
    nll -= dnorm(logN(y, 0), logN(y - 1, 0), sigma_logR, true);
  }
  
  // survival for age greater than zero
  
  // Contribution form latent process
  for(int y = 1; y < n_year; y++){
    for(int a = 1; a < n_age; a++){
      
      // If we are at max age we get contribution from same group last year
      if(a == n_age - Type(1)){
        Type pred = log(exp(logN(y - 1, a - 1) - F(y - 1, a - 1) - M(y - 1, a - 1))) +
                     log(exp(logN(y - 1, a) - F(y - 1, a) - M(y - 1, a)));
        nll -= dnorm(logN(y, a), pred, sigma_logN, true);
      } else{
        nll -= dnorm(logN(y ,a), logN(y - 1, a - 1) - F(y - 1, a - 1) - M(y - 1, a - 1), sigma_logN, true);
      }
    }
  }
  
  // Contribution from observations given latent process
  
  for(int y = 0; y < n_year; y++){
    for(int a = 0; a < n_age; a++){
     nll -= dnorm(log(Nobs(y, a)), logN(y, a), sigma_Nobs, true);
    }
  }
  
  return nll;
  
}
``` 

*** 

### C++ code step-by-step 
<details> 
  <summary> Read data and parameters from R </summary>
```c++
PARAMETER_MATRIX(logN); // Survival matrix for all age groups and years 
PARAMETER(log_sigma_Nobs); // standard deviation for observations 
PARAMETER(log_sigma_logN); // standard devitation for state equation
PARAMETER(log_sigma_logR); // stadard deviation for recruitment 

// Transform parameters
Type sigma_Nobs = exp(log_sigma_Nobs); 
Type sigma_logN = exp(log_sigma_logN); 
Type sigma_logR = exp(log_sigma_logR);

// Report to R
ADREPORT(sigma_logN);
ADREPORT(sigma_Nobs);
ADREPORT(sigma_logR);
```
</details> 

<details> 
  <summary> Contribution from $N_{1,y}$ </summary>
```c++
Type nll = 0; 
int n_year = Nobs.rows();
int n_age = Nobs.cols(); 

// Recruitment for age zero
for(int y = 1; y < n_year; y++){
  nll -= dnorm(logN(y, 0), logN(y - 1, 0), sigma_logR, true);
}
``` 
</details> 

<details> 
  <summary> Contribtion from $N_{a,y}$ for $a > 1$ </summary> 
```c++
// survival for age greater than zero

// Contribution form latent process
for(int y = 1; y < n_year; y++){
  for(int a = 1; a < n_age; a++){
    
    // If we are at max age we get contribution from same group last year
    if(a == n_age - Type(1)){
      Type pred = log(exp(logN(y - 1, a - 1) - F(y - 1, a - 1) - M(y - 1, a - 1))) +
                   log(exp(logN(y - 1, a) - F(y - 1, a) - M(y - 1, a)));
      nll -= dnorm(logN(y, a), pred, sigma_logN, true);
    } else{
      nll -= dnorm(logN(y ,a), logN(y - 1, a - 1) - F(y - 1, a - 1) - M(y - 1, a - 1), sigma_logN, true);
    }
  }
}
```
</details> 

<details> 
  <summary> Contribution form observations $N_{a,y}^{\text{obs}}$ </summary> 
```c++
// Contribution from observations given latent process

for(int y = 0; y < n_year; y++){
  for(int a = 0; a < n_age; a++){
   nll -= dnorm(log(Nobs(y, a)), logN(y, a), sigma_Nobs, true);
  }
}

return nll;

}

```

